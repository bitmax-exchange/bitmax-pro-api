## WebSocket Authentication 

You must authenticate the websocket session in order to recieve private data and send account specific requests 
(e.g. placing new orders). 

You have two options to authenticate a websocket session. 

* by adding authentication data in the request header when connecting to websocket. 
* by sending an `op:auth` message to the server after you have connected to websocket. 

Once you successfully connect to the websocket, you will receive a `connected` message: 

* for authenticated websocket session: `{"op":"connected","type":"auth"}`
* for unauthenticated websocket session: `{"op":"connected","type":"unauth"}`

If the session is disconnected for some reason, you will receive a `disconnected` message:

* `{"m":"disconnected","code":100005,"reason":"INVALID_WS_REQUEST_DATA","info":"Session is disconnected due to missing pong message from the client"}`


### Method 1 - WebSocket Authentication with Request Headers

> Authenticate with Headers

```bash
# # Install wscat from Node.js if you haven't
# npm install -g wscat  

APIPATH=stream
APIKEY=BclE7dBGbS1AP3VnOuq6s8fJH0fWbH7r
SECRET=fAZcQRUMxj3eX3DreIjFcPiJ9UR3ZTdgIw8mxddvtcDxLoXvdbXJuFQYadUUsF7q
TIMESTAMP=`date +%s%N | cut -c -13`
MESSAGE=$TIMESTAMP+$APIPATH
SIGNATURE=`echo -n $MESSAGE | openssl dgst -sha256 -hmac $SECRET -binary | base64`

wscat -H "x-auth-key: $APIKEY" \
  -H "x-auth-signature: $SIGNATURE" \
  -H "x-auth-timestamp: $TIMESTAMP" \
  -c wss://bitmax.io/1/api/v1/t/stream -w 1 -x '{"op":"sub", "id": "abc123", "ch": "order:cshQtyfq8XLAA9kcf19h8bXHbAwwoqDo:BTMX/USDT"}'
```

This is similar to the way you authenticate any RESTful request. You need to add the following header fields to the 
connection request:

* `x-auth-key`
* `x-auth-timestamp`
* `x-auth-signature`

The server will then check if the data is correctly signed before upgrading the connection protocol to WebSocket. 

Note that if you specify these header fields, the server will reject the websocket connection request if authentication fails. 


### Method 2 - WebSocket Authentication by Sending the Auth Message 

> Authenticate by Sending the `auth` Message

```bash
# # Install wscat from Node.js if you haven't
# npm install -g wscat  

APIPATH=stream
APIKEY=BclE7dBGbS1AP3VnOuq6s8fJH0fWbH7r
SECRET=fAZcQRUMxj3eX3DreIjFcPiJ9UR3ZTdgIw8mxddvtcDxLoXvdbXJuFQYadUUsF7q
TIMESTAMP=`date +%s%N | cut -c -13`
MESSAGE=$TIMESTAMP+$APIPATH
SIGNATURE=`echo -n $MESSAGE | openssl dgst -sha256 -hmac $SECRET -binary | base64`

wscat -c wss://bitmax.io/1/api/v1/pro/stream -w 1 -x "{\"op\":\"auth\", \"id\": \"abc123\", \"t\": $TIMESTAMP, "key": \"$APIKEY\", \"sig\": \"$SIGNATURE\"}"
```

You can also authenticate a live websocket session by sending an `op:auth` message to the server. 

 Name  | Type       | Required | Description                                                              
------ | ---------- | -------- | ----------------------------------------------------------------------- 
 `op`  |  `String`  | Yes      | `"auth"`                                                                
 `id`  |  `String`  | No       | optional id field, you may safely skip it                               
 `t`   |  `Long`    | Yes      | UTC timestamp in milliseconds, use this timestamp to generate signature 
 `key` |  `String`  | Yes      | your api key                                                            
 `sig` |  `String`  | Yes      | the signature is generated by signing `"<timestamp>+stream"`            

More comprehensive examples can be found at:

* Python for [websocket auth](https://github.com/bitmax-exchange/bitmax-pro-api-demo/blob/master/python/websocket_auth.py)

### Authentication Response

> Auth success message

```json
{  
  "m": "auth",
  "id": "abc123",
  "code": 0
}
```

> Auth error message

```json
{
  "m":"auth",
  "id": "abc123",
  "code": 200006,
  "err": "Unable to find User Account Data"
}
```

You will receive a message for authentication result after you send authentication request.

| Field | Type                 | Description                                                             |
| ----- | -------------------- | ----------------------------------------------------------------------- |
| `m`   |  `String`            | `"auth"`                                                                |
| `id`  |  `String`            | echo back the id if you provide one in the request                      |
| `code`|  `Long`              | Any code other than 0 indicate an error in authentication               |
| `err` |  `Optional[String]`  | Provide detailed error message if code is not 0   
